<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <title>Kassa Sistemi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { background: red; color: white; padding: 10px; border-radius: 8px; text-align: center; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 18px; font-weight: bold; }
    th, td { border: 1px solid #555; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    td input { font-size: 18px; font-weight: bold; padding: 6px; text-align: center; }
    .yekun { background: #4CAF50; color: white; font-weight: bold; font-size: 28px; }
    button { margin: 3px; padding: 6px 10px; cursor: pointer; font-size: 14px; font-weight: bold; }
    #login { text-align: center; margin-top: 60px; }
    #app { display: none; }
    #status { margin:8px 0; padding:8px; border:1px dashed #888; }
    .toolbar { display:flex; gap:10px; align-items:center; margin:8px 0 4px; flex-wrap:wrap; }
    .ops { display:flex; gap:6px; justify-content:center; }
    #historyPanel { display:none; margin-top: 12px; }
    .snap { border:1px solid #ccc; border-radius:8px; padding:10px; margin:10px 0; background:#fafafa; }
    .snap h4 { margin:0 0 8px 0; font-size:16px; }
    .snap table { width:100%; font-size:16px; font-weight: normal; }
  </style>
</head>
<body>

  <div id="status">Status: Yoxlanılır...</div>

  <!-- ÜST TOOLBAR (login OLDUQDA görünəcək) -->
  <div class="toolbar" id="topToolbar" style="justify-content:flex-start; display:none;">
    <button id="historyBtn">Tarixçə</button>
    <button id="backLiveBtn" style="display:none;">Cari vəziyyət</button>
    <button id="logoutBtn" style="margin-left:auto;background:#f44336;color:#fff;">Çıxış</button>
  </div>

  <!-- LOGIN -->
  <div id="login">
    <h2>Kassa Hesabatı</h2>
    <input type="text" id="user" placeholder="İstifadəçi adı"><br>
    <input type="password" id="pass" placeholder="Şifrə"><br>
    <button onclick="giris()">Daxil ol</button>
    <p id="error" style="color:red;"></p>
  </div>

  <!-- APP (live rejim) -->
  <div id="app">
    <h2>Kassa Hesabatı</h2>

    <div class="toolbar">
      <button id="yeniBtn">+ Sətir əlavə et</button>
    </div>

    <div id="liveWrap">
      <table id="kassa">
        <thead>
          <tr>
            <th>#</th>
            <th>Hesab</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>Əməliyyat</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr class="yekun">
            <td colspan="8">Balans: <span id="umumi">0</span></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- TARİXÇƏ PANELİ -->
  <div id="historyPanel">
    <h2 style="text-align:center;">Tarixçə</h2>
    <div id="snapshots"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, updateDoc, deleteDoc,
      doc, onSnapshot, serverTimestamp, query, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD1K5MnVvvHGIdiOTlGjQcqBqtIId7Tkz8",
      authDomain: "kassa-11972.firebaseapp.com",
      projectId: "kassa-11972",
      storageBucket: "kassa-11972.firebasestorage.app",
      messagingSenderId: "597453262060",
      appId: "1:597453262060:web:d08c7aca28522f8fd869c9",
      measurementId: "G-PXYCSSNZS5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- UI refs ---
    const statusEl = document.getElementById("status");
    const setStatus = (t) => statusEl && (statusEl.textContent = "Status: " + t);
    const fmt = (n) => new Intl.NumberFormat("az-AZ").format(n);

    const rowsCol = collection(db, "rows");
    const snapsCol = collection(db, "snapshots");

    const tbody = document.getElementById("tbody");
    const umumiEl = document.getElementById("umumi");
    const yeniBtn = document.getElementById("yeniBtn");
    const historyBtn = document.getElementById("historyBtn");
    const backLiveBtn = document.getElementById("backLiveBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const appDiv = document.getElementById("app");
    const historyPanel = document.getElementById("historyPanel");
    const snapshotsDiv = document.getElementById("snapshots");
    const topToolbar = document.getElementById("topToolbar");
    const loginDiv = document.getElementById("login");

    // --- Login state ---
    let loggedIn = false;
    let unsubscribeLive = null; // ⬅️ dinləyicini saxlamaq

    // Firebase anonim auth (Firestore üçün)
    try {
      await signInAnonymously(auth);
      setStatus("Auth OK (anonim giriş uğurlu)");
    } catch (e) {
      setStatus("Auth Xəta: " + e.message);
    }

    // Lokal LOGIN (vizual kilid)
    window.giris = function giris() {
      const user = document.getElementById("user").value.trim();
      const pass = document.getElementById("pass").value.trim();
      if (user === "admin" && pass === "1234") {
        loggedIn = true;
        loginDiv.style.display = "none";
        topToolbar.style.display = "flex";
        appDiv.style.display = "block";
        historyPanel.style.display = "none";
        backLiveBtn.style.display = "none";
        startLive(); // ⬅️ LOGIN OLDUQDA dinləyicini qoş
      } else {
        document.getElementById("error").innerText = "İstifadəçi adı və ya şifrə yanlışdır!";
      }
    };

    // ÇIXIŞ düyməsi
    logoutBtn.onclick = async () => {
      if (!loggedIn) return;
      const ok = confirm("Çıxmaq istədiyinizə əminsiniz?");
      if (!ok) return;
      try { await signOut(auth); } catch (e) {}
      stopLive(); // ⬅️ dinləyicini söndür
      // UI reset
      loggedIn = false;
      topToolbar.style.display = "none";
      appDiv.style.display = "none";
      historyPanel.style.display = "none";
      backLiveBtn.style.display = "none";
      // görünən məlumatları təmizlə
      tbody.innerHTML = "";
      snapshotsDiv.innerHTML = "";
      umumiEl.textContent = "0";
      loginDiv.style.display = "block";
      setStatus("Çıxıldı (giriş tələb olunur)");
    };

    // --- Live dinləyici (yenidən qoşulan) ---
    function startLive() {
      // Əvvəl açıqsa bağla
      stopLive();
      const q = query(rowsCol, orderBy("createdAt","asc"));
      unsubscribeLive = onSnapshot(q, (snap) => {
        if (!loggedIn) return; // ehtiyat
        tbody.innerHTML = "";
        let total = 0;
        let idx = 0;

        snap.forEach((d) => {
          const data = d.data();
          const tr = createRow(d.id, data, idx);
          tbody.appendChild(tr);

          for (let i = 1; i <= 5; i++) {
            total += Number(data["n"+i] ?? 0) || 0;
          }
          idx++;
        });

        umumiEl.textContent = fmt(total);
        setStatus("Firestore OK (real-time qoşuldu)");
      }, (err) => {
        setStatus("Firestore Xəta: " + err.message);
      });
    }

    function stopLive() {
      if (unsubscribeLive) {
        unsubscribeLive();
        unsubscribeLive = null;
      }
    }

    // Sətir qur
    function createRow(docId, data, index) {
      const tr = document.createElement("tr");
      tr.dataset.id = docId;

      const tdNo = document.createElement("td");
      tdNo.textContent = index + 1;
      tr.appendChild(tdNo);

      const tdAcc = document.createElement("td");
      const inpAcc = document.createElement("input");
      inpAcc.type = "text";
      inpAcc.placeholder = "Hesab adı";
      inpAcc.value = data.account || "";
      inpAcc.onchange = () => updateDoc(doc(db, "rows", docId), { account: inpAcc.value ?? "" }).then(() => { if (loggedIn) saveSnapshot(); });
      tdAcc.appendChild(inpAcc);
      tr.appendChild(tdAcc);

      const numberInputs = [];
      for (let i = 1; i <= 5; i++) {
        const td = document.createElement("td");
        const inp = document.createElement("input");
        inp.type = "number";
        inp.value = (data["n"+i] ?? "") === null ? "" : (data["n"+i] ?? "");
        inp.onchange = () => {
          const v = inp.value === "" ? null : Number(inp.value);
          updateDoc(doc(db, "rows", docId), { ["n"+i]: v }).then(() => { if (loggedIn) saveSnapshot(); });
        };
        td.appendChild(inp);
        tr.appendChild(td);
        numberInputs.push(inp);
      }

      const tdOps = document.createElement("td");
      const ops = document.createElement("div");
      ops.className = "ops";

      const btnSum = document.createElement("button");
      btnSum.textContent = "Cəmlə";
      btnSum.onclick = async () => {
        if (!loggedIn) return;
        const cur = {
          n1: Number(numberInputs[0].value) || 0,
          n2: Number(numberInputs[1].value) || 0,
          n3: Number(numberInputs[2].value) || 0,
          n4: Number(numberInputs[3].value) || 0,
          n5: Number(numberInputs[4].value) || 0,
        };
        const sum = cur.n1 + cur.n2 + cur.n3 + cur.n4 + cur.n5;

        await updateDoc(doc(db, "rows", docId), {
          backup: {
            n1: data.n1 ?? null,
            n2: data.n2 ?? null,
            n3: data.n3 ?? null,
            n4: data.n4 ?? null,
            n5: data.n5 ?? null
          },
          n1: sum, n2: null, n3: null, n4: null, n5: null
        });
        await saveSnapshot();
      };

      const btnUndo = document.createElement("button");
      btnUndo.textContent = "Geri";
      btnUndo.onclick = async () => {
        if (!loggedIn) return;
        if (data.backup) {
          await updateDoc(doc(db, "rows", docId), {
            n1: data.backup.n1 ?? null,
            n2: data.backup.n2 ?? null,
            n3: data.backup.n3 ?? null,
            n4: data.backup.n4 ?? null,
            n5: data.backup.n5 ?? null,
            backup: null
          });
          await saveSnapshot();
        } else {
          alert("Geri qaytarmaq üçün əvvəlcə Cəmlə istifadə olunmalıdır!");
        }
      };

      const btnDel = document.createElement("button");
      btnDel.textContent = "Sil";
      btnDel.onclick = async () => { if (!loggedIn) return; await deleteDoc(doc(db, "rows", docId)); await saveSnapshot(); };

      ops.appendChild(btnSum);
      ops.appendChild(btnUndo);
      ops.appendChild(btnDel);
      tdOps.appendChild(ops);
      tr.appendChild(tdOps);

      return tr;
    }

    // Yeni sətir
    yeniBtn.onclick = async () => {
      if (!loggedIn) return;
      try {
        await addDoc(rowsCol, {
          account: "",
          n1: null, n2: null, n3: null, n4: null, n5: null,
          createdAt: serverTimestamp(),
          backup: null
        });
        await saveSnapshot();
      } catch (e) {
        setStatus("AddDoc Xəta: " + e.message);
      }
    };

    // --- Tarixçə ---
    async function saveSnapshot() {
      try {
        if (!loggedIn) return;
        const qRows = query(rowsCol, orderBy("createdAt","asc"));
        const snap = await getDocs(qRows);
        const rows = [];
        let i = 1;
        snap.forEach(docu => {
          const r = docu.data();
          rows.push({
            no: i++,
            account: r.account || "",
            n1: r.n1 ?? "",
            n2: r.n2 ?? "",
            n3: r.n3 ?? "",
            n4: r.n4 ?? "",
            n5: r.n5 ?? ""
          });
        });
        await addDoc(snapsCol, { createdAt: serverTimestamp(), rows });
      } catch (e) {
        alert("Tarixçə yazılmadı: " + e.message);
      }
    }

    historyBtn.onclick = async () => {
      if (!loggedIn) return;
      appDiv.style.display = "none";
      historyPanel.style.display = "block";
      backLiveBtn.style.display = "inline-block";
      await renderHistory();
    };

    backLiveBtn.onclick = () => {
      if (!loggedIn) return;
      historyPanel.style.display = "none";
      appDiv.style.display = "block";
      backLiveBtn.style.display = "none";
    };

    async function renderHistory() {
      try {
        snapshotsDiv.innerHTML = "Yüklənir...";
        const qSnaps = query(snapsCol, orderBy("createdAt","desc"));
        const snap = await getDocs(qSnaps);
        if (snap.empty) {
          snapshotsDiv.innerHTML = "<i>Hələ tarixçə yoxdur.</i>";
          return;
        }
        const parts = [];
        snap.forEach(s => {
          const d = s.data();
          const when = d.createdAt?.toDate?.()
            ? d.createdAt.toDate().toLocaleString("az-AZ")
            : "(vaxt yoxdur)";
          const rows = d.rows || [];
          let rowsHtml = `
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Hesab</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
                </tr>
              </thead>
              <tbody>
          `;
          rows.forEach(r => {
            rowsHtml += `
              <tr>
                <td>${r.no ?? ""}</td>
                <td>${escapeHtml(r.account ?? "")}</td>
                <td>${r.n1 ?? ""}</td>
                <td>${r.n2 ?? ""}</td>
                <td>${r.n3 ?? ""}</td>
                <td>${r.n4 ?? ""}</td>
                <td>${r.n5 ?? ""}</td>
              </tr>
            `;
          });
          rowsHtml += `</tbody></table>`;

          parts.push(`
            <div class="snap">
              <h4>${when}</h4>
              ${rowsHtml}
            </div>
          `);
        });
        snapshotsDiv.innerHTML = parts.join("");
      } catch (e) {
        snapshotsDiv.innerHTML = "";
        alert("Tarixçə oxuna bilmədi: " + e.message);
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }
  </script>
</body>
</html>
