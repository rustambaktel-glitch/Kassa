<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <title>Kassa Sistemi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { background: red; color: white; padding: 8px; border-radius: 6px; text-align: center; font-size: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 16px; font-weight: bold; }
    th, td { border: 1px solid #555; padding: 4px; text-align: center; }
    th { background: #f0f0f0; }
    td input { font-size: 16px; font-weight: bold; padding: 4px; text-align: center; }
    td input[type="number"] { width: 80px; }
    .yekun { background: #4CAF50; color: white; font-weight: bold; font-size: 26px; }
    button { margin: 2px; padding: 4px 8px; cursor: pointer; font-size: 13px; font-weight: bold; }
    #status { margin:6px 0; padding:6px; border:1px dashed #888; font-size: 14px; }
    .toolbar { display:flex; gap:8px; align-items:center; margin:6px 0 4px; flex-wrap:wrap; }
    .ops { display:flex; gap:4px; justify-content:center; }

    /* Login */
    #login { text-align: center; margin-top: 50px; }
    #login h2 { margin-bottom: 14px; font-size: 22px; }
    #login input {
      font-size: 18px; padding: 8px 12px; width: 240px; margin: 6px 0;
      border: 1px solid #bbb; border-radius: 8px; outline: none;
    }
    #login button {
      font-size: 16px; padding: 10px 18px; border-radius: 10px;
      background: #4CAF50; color: #fff; border: none; margin-top: 8px; min-width: 180px;
    }

    #app { display: none; }
    #topToolbar { justify-content:flex-start; display:none; }
    #historyPanel { display:none; margin-top: 10px; }
    .snap { border:1px solid #ccc; border-radius:6px; padding:8px; margin:8px 0; background:#fafafa; }
    .snap h4 { margin:0 0 6px 0; font-size:14px; }
    .snap table { width:100%; font-size:14px; font-weight: normal; }
  </style>
</head>
<body>

  <div id="status">Status: Yoxlanılır...</div>

  <div class="toolbar" id="topToolbar">
    <button id="historyBtn">Tarixçə</button>
    <button id="backLiveBtn" style="display:none;">Cari vəziyyət</button>
    <button id="logoutBtn" style="margin-left:auto;background:#f44336;color:#fff;">Çıxış</button>
  </div>

  <div id="login">
    <h2>Kassa Hesabatı</h2>
    <input type="text" id="user" placeholder="İstifadəçi adı"><br>
    <input type="password" id="pass" placeholder="Şifrə"><br>
    <button onclick="giris()">Daxil ol</button>
    <p id="error" style="color:red;"></p>
  </div>

  <div id="app">
    <h2>Kassa Hesabatı</h2>
    <div class="toolbar"><button id="yeniBtn">+ Sətir əlavə et</button></div>
    <div id="liveWrap">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Hesab</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>Əməliyyat</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot><tr class="yekun"><td colspan="8">Balans: <span id="umumi">0</span></td></tr></tfoot>
      </table>
    </div>
  </div>

  <div id="historyPanel">
    <h2 style="text-align:center;">Tarixçə</h2>
    <div id="snapshots"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, updateDoc, deleteDoc,
      doc, onSnapshot, serverTimestamp, query, orderBy, getDocs, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD1K5MnVvvHGIdiOTlGjQcqBqtIId7Tkz8",
      authDomain: "kassa-11972.firebaseapp.com",
      projectId: "kassa-11972",
      storageBucket: "kassa-11972.firebasestorage.app",
      messagingSenderId: "597453262060",
      appId: "1:597453262060:web:d08c7aca28522f8fd869c9",
      measurementId: "G-PXYCSSNZS5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const statusEl=document.getElementById("status");
    const setStatus=(t)=>statusEl.textContent="Status: "+t;
    const fmt=(n)=>new Intl.NumberFormat("az-AZ").format(n);

    const rowsCol=collection(db,"rows");
    const snapsCol=collection(db,"snapshots");

    const tbody=document.getElementById("tbody");
    const umumiEl=document.getElementById("umumi");
    const yeniBtn=document.getElementById("yeniBtn");
    const historyBtn=document.getElementById("historyBtn");
    const backLiveBtn=document.getElementById("backLiveBtn");
    const logoutBtn=document.getElementById("logoutBtn");
    const appDiv=document.getElementById("app");
    const historyPanel=document.getElementById("historyPanel");
    const snapshotsDiv=document.getElementById("snapshots");
    const topToolbar=document.getElementById("topToolbar");
    const loginDiv=document.getElementById("login");

    let loggedIn=false, unsubscribeLive=null, isEditing=false, hasPendingSnapshot=false, latestDocs=[], authReady=false;

    onAuthStateChanged(auth, async (user)=>{
      if(user){ authReady=true; setStatus("Auth OK"); if(loggedIn && !unsubscribeLive) startLive(); }
      else{ authReady=false; setStatus("Auth yoxdur, qoşulur..."); try{ await signInAnonymously(auth);}catch(e){setStatus("Auth Xəta: "+e.message);} }
    });
    try{ await signInAnonymously(auth);}catch(e){}

    tbody.addEventListener('focusin',()=>{isEditing=true;},true);
    tbody.addEventListener('focusout',()=>{setTimeout(()=>{isEditing=false;if(hasPendingSnapshot){renderFromDocs(latestDocs);hasPendingSnapshot=false;}},80);},true);

    window.giris=function(){ const u=document.getElementById("user").value.trim(),p=document.getElementById("pass").value.trim();
      if(u==="admin"&&p==="1234"){ loggedIn=true; loginDiv.style.display="none"; topToolbar.style.display="flex"; appDiv.style.display="block"; historyPanel.style.display="none"; backLiveBtn.style.display="none"; if(authReady) startLive();}
      else document.getElementById("error").innerText="İstifadəçi adı və ya şifrə yanlışdır!"; };

    logoutBtn.onclick=async()=>{ if(!loggedIn) return; if(!confirm("Çıxmaq istədiyinizə əminsiniz?")) return;
      loggedIn=false; stopLive(); topToolbar.style.display="none"; appDiv.style.display="none"; historyPanel.style.display="none"; backLiveBtn.style.display="none";
      tbody.innerHTML=""; snapshotsDiv.innerHTML=""; umumiEl.textContent="0"; loginDiv.style.display="block"; setStatus("Çıxıldı"); try{ await signOut(auth);}catch(e){} };

    function startLive(){ stopLive(); const q=query(rowsCol,orderBy("createdAt","asc"));
      unsubscribeLive=onSnapshot(q,(snap)=>{ if(!loggedIn) return; latestDocs=[]; snap.forEach(d=>latestDocs.push({id:d.id,data:d.data()}));
        if(isEditing) hasPendingSnapshot=true; else renderFromDocs(latestDocs); setStatus("Firestore OK"); },
        (err)=>setStatus("Firestore Xəta: "+err.message)); }
    function stopLive(){ if(unsubscribeLive){unsubscribeLive();unsubscribeLive=null;} }
    async function fetchAndRender(){ const q=query(rowsCol,orderBy("createdAt","asc")); const snap=await getDocs(q); latestDocs=[]; snap.forEach(d=>latestDocs.push({id:d.id,data:d.data()})); renderFromDocs(latestDocs);}
    function renderFromDocs(docs){ tbody.innerHTML=""; let total=0,idx=0; docs.forEach(({id,data})=>{ const tr=createRow(id,data,idx); tbody.appendChild(tr); for(let i=1;i<=5;i++) total+=Number(data["n"+i]??0)||0; idx++; }); umumiEl.textContent=fmt(total); }

    function createRow(docId,data,index){ const tr=document.createElement("tr"); tr.dataset.id=docId;
      const tdNo=document.createElement("td"); tdNo.textContent=index+1; tr.appendChild(tdNo);
      const tdAcc=document.createElement("td"); const inpAcc=document.createElement("input"); inpAcc.type="text"; inpAcc.placeholder="Hesab adı"; inpAcc.value=data.account||"";
      inpAcc.onblur=async()=>{ if(!loggedIn) return; await updateDoc(doc(db,"rows",docId),{account:inpAcc.value??""}); await saveSnapshot(); await fetchAndRender(); };
      tdAcc.appendChild(inpAcc); tr.appendChild(tdAcc);
      const numberInputs=[]; for(let i=1;i<=5;i++){ const td=document.createElement("td"); const inp=document.createElement("input"); inp.type="number"; inp.step="any"; inp.value=(data["n"+i]??"")===null?"":(data["n"+i]??"");
        inp.onblur=async()=>{ if(!loggedIn) return; const v=inp.value===""?null:Number(inp.value); await updateDoc(doc(db,"rows",docId),{["n"+i]:v}); await saveSnapshot(); await fetchAndRender(); };
        td.appendChild(inp); tr.appendChild(td); numberInputs.push(inp);}
      const tdOps=document.createElement("td"); const ops=document.createElement("div"); ops.className="ops";
      const btnSum=document.createElement("button"); btnSum.textContent="Cəmlə"; btnSum.onclick=async()=>{ if(!loggedIn) return; const cur={n1:Number(numberInputs[0].value)||0,n2:Number(numberInputs[1].value)||0,n3:Number(numberInputs[2].value)||0,n4:Number(numberInputs[3].value)||0,n5:Number(numberInputs[4].value)||0};
        const backup={n1:numberInputs[0].value===""?null:Number(numberInputs[0].value),n2:numberInputs[1].value===""?null:Number(numberInputs[1].value),n3:numberInputs[2].value===""?null:Number(numberInputs[2].value),n4:numberInputs[3].value===""?null:Number(numberInputs[3].value),n5:numberInputs[4].value===""?null:Number(numberInputs[4].value)};
        const sum=cur.n1+cur.n2+cur.n3+cur.n4+cur.n5; await updateDoc(doc(db,"rows",docId),{backup,n1:sum,n2:null,n3:null,n4:null,n5:null}); await saveSnapshot(); await fetchAndRender(); };
      const btnUndo=document.createElement("button"); btnUndo.textContent="Geri"; btnUndo.onclick=async()=>{ if(!loggedIn) return; const rowRef=doc(db,"rows",docId); const rowSnap=await getDoc(rowRef); const d=rowSnap.data();
        if(d&&d.backup){ await updateDoc(rowRef,{n1:d.backup.n1??null,n2:d.backup.n2??null,n3:d.backup.n3??null,n4:d.backup.n4??null,n5:d.backup.n5??null,backup:null}); await saveSnapshot(); await fetchAndRender(); }
        else alert("Geri üçün əvvəlcə Cəmlə istifadə olunmalıdır!"); };
      const btnDel=document.createElement("button"); btnDel.textContent="Sil"; btnDel.onclick=async()=>{ if(!loggedIn) return; await deleteDoc(doc(db,"rows",docId)); await saveSnapshot(); await fetchAndRender(); };
      ops.appendChild(btnSum); ops.appendChild(btnUndo); ops.appendChild(btnDel); tdOps.appendChild(ops); tr.appendChild(tdOps); return tr; }

    yeniBtn.onclick=async()=>{ if(!loggedIn) return; await addDoc(rowsCol,{account:"",n1:null,n2:null,n3:null,n4:null,n5:null,createdAt:serverTimestamp(),backup:null}); await saveSnapshot(); await fetchAndRender(); };

    async function saveSnapshot(){ try{ if(!loggedIn) return; const qRows=query(rowsCol,orderBy("createdAt","asc")); const snap=await getDocs(qRows); const rows=[]; let i=1;
      snap.forEach(docu=>{ const r=docu.data(); rows.push({no:i++,account:r.account||"",n1:r.n1??"",n2:r.n2??"",n3:r.n3??"",n4:r.n4??"",n5:r.n5??""}); }); await addDoc(snapsCol,{createdAt:serverTimestamp(),rows}); }catch(e){console.warn("Tarixçə yazılmadı:",e.message);} }

    historyBtn.onclick=async()=>{ if(!loggedIn) return; appDiv.style.display="none"; historyPanel.style.display="block"; backLiveBtn.style.display="inline-block"; await renderHistory(); };
    backLiveBtn.onclick=()=>{ if(!loggedIn) return; historyPanel.style.display="none"; appDiv.style.display="block"; backLiveBtn.style.display="none"; };

    async function renderHistory(){ try{ snapshotsDiv.innerHTML="Yüklənir..."; const qSnaps=query(snapsCol,orderBy("createdAt","desc")); const snap=await getDocs(qSnaps);
      if(snap.empty){ snapshotsDiv.innerHTML="<i>Hələ tarixçə yoxdur.</i>"; return; } const parts=[]; snap.forEach(s=>{ const d=s.data(); const when=d.createdAt?.toDate?.()?d.createdAt.toDate().toLocaleString("az-AZ"):"(vaxt yoxdur)"; const rows=d.rows||[];
        let rowsHtml=`<table><thead><tr><th>#</th><th>Hesab</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr></thead><tbody>`; rows.forEach(r=>{ rowsHtml+=`<tr><td>${r.no??""}</td><td>${escapeHtml(r.account??"")}</td><td>${r.n1??""}</td><td>${r.n2??""}</td><td>${r.n3??""}</td><td>${r.n4??""}</td><td>${r.n5??""}</td></tr>`; }); rowsHtml+=`</tbody></table>`;
        parts.push(`<div class="snap"><h4>${when}</h4>${rowsHtml}</div>`); }); snapshotsDiv.innerHTML=parts.join(""); }catch(e){snapshotsDiv.innerHTML=""; alert("Tarixçə oxuna bilmədi: "+e.message);} }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>
</body>
</html>
